<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>服务端开发(6) K8S | Whale&#39;s Blog | Stay hungry, Stay foolish</title>

  
  <meta name="author" content="Whale">
  

  
  <meta name="description" content="码农预备役">
  

  
  
  <meta name="keywords" content="K8S">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="服务端开发(6) K8S"/>

  <meta property="og:site_name" content="Whale&#39;s Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Whale&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Whale&#39;s Blog</a>
    </h1>
    <p class="site-description">Stay hungry, Stay foolish</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>服务端开发(6) K8S</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/03/21/服务端开发-6-K8S/" rel="bookmark">
        <time class="entry-date published" datetime="2023-03-21T11:52:35.000Z">
          2023-03-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="0-准备工作"><a href="#0-准备工作" class="headerlink" title="0. 准备工作"></a>0. 准备工作</h2><p>安装 k8s</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/k8s-for-docker-desktop">https://github.com/AliyunContainerService/k8s-for-docker-desktop</a></li>
</ul>
<p>部署 dashboard</p>
<ul>
<li><code>kubectl apply -f kubernetes-dashboard.yaml</code></li>
<li>检查 kubernetes-dashboard 应用状态<ul>
<li><code>kubectl get pod -n kubernetes-dashboard</code></li>
</ul>
</li>
<li>将k8s server代理到本地端口：<code>kubectl proxy</code></li>
<li>配置控制台访问令牌</li>
</ul>
<p>启动ingress controller</p>
<ul>
<li><code>kubectl apply -f ingress-nginx-controller.yaml</code></li>
</ul>
<p>验证 Kubernetes 集群状态</p>
<ul>
<li><code>kubectl cluster-info</code></li>
<li><code>kubectl get nodes</code></li>
<li><code>kubectl get nodes --show-labels</code></li>
<li>给节点打标签：<code>kubectl label node docker-desktop disktype=ssd</code></li>
</ul>
<h2 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="1. 核心概念"></a>1. 核心概念</h2><h3 id="1-1-Kubernetes-基本架构"><a href="#1-1-Kubernetes-基本架构" class="headerlink" title="1.1 Kubernetes 基本架构"></a>1.1 Kubernetes 基本架构</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230406003846139.png" alt="image-20230406003846139" style="zoom:80%;" /></p>
<h3 id="1-2-k8s中的资源"><a href="#1-2-k8s中的资源" class="headerlink" title="1.2 k8s中的资源"></a>1.2 k8s中的资源</h3><ul>
<li>namespaces</li>
<li>Pods</li>
<li>ReplicaSet</li>
<li>Deployment</li>
<li>Service</li>
<li>Ingress</li>
<li>configmap</li>
<li>secrets</li>
<li>serviceaccounts</li>
<li>DaemonSet</li>
</ul>
<h3 id="1-3-核心概念"><a href="#1-3-核心概念" class="headerlink" title="1.3 核心概念"></a>1.3 核心概念</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230406003955811.png" alt="image-20230406003955811"></p>
<h4 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h4><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230406004020943.png" alt="image-20230406004020943"></p>
<h4 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ce71385e0370">Pod</a></h4><p>Pod 是 Kubernetes 调度的最小单元</p>
<p>一个 Pod 可以包含一个或多个容器，因此它可以被看作是内部容器的逻辑宿主机。Pod 的设计理念是为了支持多个容器在一个 Pod 中共享网络和文件系统</p>
<ul>
<li>PID 命名空间：Pod中不同的应用程序可以看到其他应用程序的进程ID</li>
<li>network 命名空间：Pod 中多个容器处于同一个网络命名空间，因此能够访问的 IP 和端口范围都是相同的。也可以通过 localhost 相互访问</li>
<li>IPC 命名空间：Pod 中的多个容器共享 Inner-process Communication 命名空间，因此可以通过 SystemV IPC 或 POSIX 进行进程间通信</li>
<li>UTS 命名空间：Pod 中的多个容器共享同一个主机名</li>
<li>Volumes：Pod 中各个容器可以共享在 Pod 中定义分存储卷（Volume）</li>
</ul>
<p>restartPolicy 字段</p>
<ul>
<li>Always：只要退出就重启</li>
<li>OnFailure：失败退出时（exit code不为0）才重启</li>
<li>Never：永远不重启</li>
</ul>
<h4 id="Pod、Container-与-Node-之间的关系"><a href="#Pod、Container-与-Node-之间的关系" class="headerlink" title="Pod、Container 与 Node 之间的关系"></a>Pod、Container 与 Node 之间的关系</h4><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230406004354883.png" alt="image-20230406004354883"  /></p>
<h2 id="2-K8S-操作"><a href="#2-K8S-操作" class="headerlink" title="2. K8S 操作"></a>2. K8S 操作</h2><h4 id="创建一个pod"><a href="#创建一个pod" class="headerlink" title="创建一个pod"></a>创建一个pod</h4><ul>
<li><p><code>kubectl run myspittr --image spittr:1.0-SNAPSHOT</code></p>
</li>
<li><p><code>kubectl get pods</code></p>
</li>
<li><p><code>kubectl logs -f myspittr</code></p>
</li>
<li><p>pod中执行一个命令</p>
<ul>
<li><code>kubectl exec myspittr -- ls /run/secrets/kubernetes.io/serviceaccount</code></li>
</ul>
</li>
<li><p><code>kubectl delete pod myspittr</code></p>
</li>
</ul>
<h4 id="如何将pod或service的端口快速映射到本机端口（调试用）"><a href="#如何将pod或service的端口快速映射到本机端口（调试用）" class="headerlink" title="如何将pod或service的端口快速映射到本机端口（调试用）"></a>如何将pod或service的端口快速映射到本机端口（调试用）</h4><ul>
<li><p><code>kubectl port-forward pod/myspittr 8081:8080</code></p>
<ul>
<li>访问：<a target="_blank" rel="noopener" href="http://localhost:8081/spittr/">http://localhost:8081/spittr/</a></li>
</ul>
</li>
<li><p><code>kubectl port-forward service/demo 8081:80</code></p>
</li>
</ul>
<h4 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h4><ul>
<li><p><code>kubectl expose pod myspittr --port 8080</code></p>
</li>
<li><p><code>kubectl get svc</code></p>
</li>
<li><p><code>kubectl delete service myspittr</code></p>
</li>
</ul>
<h4 id="创建-ingress"><a href="#创建-ingress" class="headerlink" title="创建 ingress"></a>创建 ingress</h4><ul>
<li><p><code>kubectl create ingress myspittr --class=nginx --rule=www.demo.com/*=myspittr:8080</code></p>
<ul>
<li>访问：<a target="_blank" rel="noopener" href="http://www.demo.com/spittr/">http://www.demo.com/spittr/</a></li>
</ul>
</li>
<li><p><code>kubectl delete ingress myspittr</code></p>
</li>
</ul>
<h4 id="如何使用命令行快捷创建deployment、service、ingress"><a href="#如何使用命令行快捷创建deployment、service、ingress" class="headerlink" title="如何使用命令行快捷创建deployment、service、ingress"></a>如何使用命令行快捷创建deployment、service、ingress</h4><ul>
<li><p><code>kubectl create deployment myspittr --image=spittr:1.0-SNAPSHOT --port=8080</code></p>
</li>
<li><p><code>kubectl expose deployment myspittr</code></p>
<ul>
<li>把上面的这个pod的8080端口暴露为myspittr服务</li>
</ul>
</li>
<li><p><code>kubectl create ingress myspittr --class=nginx --rule=www.demo.com/*=myspittr:8080</code></p>
</li>
<li><p>访问：<a target="_blank" rel="noopener" href="http://www.demo.com/spittr/">http://www.demo.com/spittr/</a></p>
</li>
</ul>
<p>删除：</p>
<ul>
<li><code>kubectl delete ingress myspittr</code></li>
<li><code>kubectl delete service myspittr</code></li>
<li><code>kubectl delete deployment myspittr</code></li>
</ul>
<h2 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h2><h4 id="使用yaml文件部署"><a href="#使用yaml文件部署" class="headerlink" title="使用yaml文件部署"></a>使用yaml文件部署</h4><ul>
<li><code>kubectl create -f k8s-deploy.yaml</code></li>
<li><code>kubectl delete -f k8s-deploy.yaml</code></li>
</ul>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/029661f38674">Deployment</a></h4><ul>
<li>更新镜像重部署<ul>
<li><code>kubectl set image deployment/spittr spittr=spittr:1.0</code></li>
</ul>
</li>
<li>扩容<ul>
<li><code>kubectl scale deployment spittr --replicas 2</code></li>
</ul>
</li>
<li>自动<ul>
<li><code>kubectl autoscale deployment spittr --min=10 --max=15 --cpu-percent=80</code></li>
</ul>
</li>
<li>查看历史版本<ul>
<li><code>kubectl rollout history deployment/spittr</code></li>
</ul>
</li>
<li>回滚到前一个版本<ul>
<li><code>kubectl rollout undo deployment/spittr</code></li>
</ul>
</li>
</ul>
<h2 id="4-k8s常用命令"><a href="#4-k8s常用命令" class="headerlink" title="4. k8s常用命令"></a>4. k8s常用命令</h2><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230406005721950.png" alt="image-20230406005721950"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/NJU/">NJU</a>, <a href="/categories/NJU/服务端开发/">服务端开发</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/K8S/">K8S</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 Whale
    
  </p>
</footer>
    
    
  </div>
</div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<!--<script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>-->
<!--<script src="//cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>