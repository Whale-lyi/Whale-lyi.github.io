<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>服务端开发(9) 基于Sentinel的流控与熔断 | Whale&#39;s Blog | Stay hungry, Stay foolish</title>

  
  <meta name="author" content="Whale">
  

  
  <meta name="description" content="码农预备役">
  

  
  
  <meta name="keywords" content="Sentinel">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="服务端开发(9) 基于Sentinel的流控与熔断"/>

  <meta property="og:site_name" content="Whale&#39;s Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Whale&#39;s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Whale&#39;s Blog</a>
    </h1>
    <p class="site-description">Stay hungry, Stay foolish</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>服务端开发(9) 基于Sentinel的流控与熔断</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2023/04/08/服务端开发-9-Sentinel/" rel="bookmark">
        <time class="entry-date published" datetime="2023-04-08T06:33:56.000Z">
          2023-04-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="1-Sentinel"><a href="#1-Sentinel" class="headerlink" title="1. Sentinel"></a>1. Sentinel</h3><ul>
<li>Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性</li>
<li>源代码：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a><ul>
<li>其中例子代码：Sentinel/sentinel-demo</li>
</ul>
</li>
<li>Dashboard下载：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></li>
<li>中文用户文档：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">https://sentinelguard.io/zh-cn/docs/introduction.html</a></li>
</ul>
<h4 id="Sentinel组成"><a href="#Sentinel组成" class="headerlink" title="Sentinel组成"></a>Sentinel组成</h4><ul>
<li>核心库（Java 客户端）：不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持</li>
<li>控制台（Dashboard）：Dashboard 主要负责管理推送规则、监控、管理机器信息等</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408151555033.png" alt="image-20230408151555033"></p>
<blockquote>
<p>控制台不维护规则，仅会通过端口查看</p>
</blockquote>
<h3 id="2-使用步骤"><a href="#2-使用步骤" class="headerlink" title="2. 使用步骤"></a>2. 使用步骤</h3><ol>
<li>定义资源<ul>
<li>代码直接定义</li>
<li>使用注解定义</li>
<li>自动定义</li>
</ul>
</li>
<li>定义规则<ul>
<li>流量控制规则</li>
<li>熔断降级规则</li>
<li>系统保护规则</li>
<li>来源访问控制规则</li>
<li>热点参数规则</li>
</ul>
</li>
<li>查看效果<ul>
<li>日志</li>
<li>Dashboard</li>
</ul>
</li>
</ol>
<h4 id="定义资源"><a href="#定义资源" class="headerlink" title="定义资源"></a>定义资源</h4><ul>
<li><p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码</p>
</li>
<li><p>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源</p>
</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408152504931.png" alt="image-20230408152504931" style="zoom: 80%;" /></p>
<h4 id="定义规则"><a href="#定义规则" class="headerlink" title="定义规则"></a>定义规则</h4><ul>
<li>围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408152626363.png" alt="image-20230408152626363"></p>
<ul>
<li>规则的种类<ul>
<li>流量控制规则</li>
<li>熔断降级规则</li>
<li>系统保护规则（CPU、内存占用等）</li>
<li>来源访问控制规则（客户端来源）</li>
<li>热点参数规则（依据请求的某一个参数来做限定）</li>
</ul>
</li>
</ul>
<h4 id="查看效果"><a href="#查看效果" class="headerlink" title="查看效果"></a>查看效果</h4><ul>
<li>QPS一般指每秒查询率。每秒查询率（QPS，Queries-per-second）是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准</li>
<li><p>日志路径：C:\Users\14669\logs\csp\com-alibaba-csp-sentinel-demo-flow-FlowQpsDemo-metrics.log.2023-04-08</p>
</li>
<li><p>—timestamp-|———date time——|—resource—|p|block|s|e|rt</p>
<ul>
<li>p 代表通过的请求, block 代表被阻止的请求, s 代表成功执行完成的请求个数, e 代表用户自定义的异常, rt 代表平均响应时长</li>
</ul>
</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408155015781.png" alt="image-20230408155015781" style="zoom:80%;" /></p>
<h3 id="3-简单的例子"><a href="#3-简单的例子" class="headerlink" title="3. 简单的例子"></a>3. 简单的例子</h3><h4 id="SentinelResource-注解（基于Spring-Boot）"><a href="#SentinelResource-注解（基于Spring-Boot）" class="headerlink" title="@SentinelResource 注解（基于Spring Boot）"></a><code>@SentinelResource</code> 注解（基于Spring Boot）</h4><ul>
<li>文档（注解支持）：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/annotation-support.html">https://sentinelguard.io/zh-cn/docs/annotation-support.html</a></li>
<li>例子代码：Sentinel/sentinel-demo/sentinel-demo-annotation-spring-aop</li>
<li>依赖：sentinel-core、sentinel-annotation-aspectj、sentinel-transport-simple-http（与控制台连接）</li>
<li><p>配置Bean <code>SentinelResourceAspect</code>、注解 <code>@SentinelResource</code></p>
</li>
<li><p>sentinel.properties（配置项）</p>
<ul>
<li>文档：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/startup-configuration.html">https://sentinelguard.io/zh-cn/docs/startup-configuration.html</a></li>
<li><code>csp.sentinel.dashboard.server=www.sentinel.com:80</code></li>
<li><code>csp.sentinel.api.port=8719</code></li>
<li><code>project.name=mydemo</code></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/cristianoxm/article/details/113745358">blockHandler与fallback的区别</a></p>
</li>
</ul>
<h4 id="Sentinel-控制台"><a href="#Sentinel-控制台" class="headerlink" title="Sentinel 控制台"></a>Sentinel 控制台</h4><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/dashboard.html">https://sentinelguard.io/zh-cn/docs/dashboard.html</a></li>
<li><p>配置控制台的参数传入</p>
<ul>
<li><code>java -Dcsp.sentinel.dashboard.server=www.sentinel.com:80 ......</code></li>
<li><code>mvn spring-boot:run -Dspring-boot.run.jvmArguments=&quot;-Dcsp.sentinel.dashboard.server=www.sentinel.com:80&quot;</code></li>
</ul>
</li>
<li><p>配置应用的端口号</p>
<ul>
<li>应用默认端口号：8719</li>
<li><code>csp.sentinel.api.port=8719</code></li>
</ul>
</li>
</ul>
<h3 id="4-限流"><a href="#4-限流" class="headerlink" title="4. 限流"></a>4. 限流</h3><ul>
<li>限流的直接表现是在执行 <code>Entry nodeA = SphU.entry(资源名字)</code> 的时候抛出 FlowException 异常</li>
<li>FlowException 是 BlockException 的子类，您可以捕捉 BlockException 来自定义被限流之后的处理逻辑</li>
<li>一条限流规则主要由下面几个因素组成，我们可以组合这些元素来实现不同的限流效果<ul>
<li>resource：资源名，即限流规则的作用对象</li>
<li>count: 限流阈值</li>
<li>grade: 限流阈值类型，QPS 或线程数</li>
<li>strategy: 根据调用关系选择策略</li>
</ul>
</li>
</ul>
<h4 id="并发线程数流量控制"><a href="#并发线程数流量控制" class="headerlink" title="并发线程数流量控制"></a>并发线程数流量控制</h4><ul>
<li>线程数限流用于保护业务线程数不被耗尽</li>
<li><p>Sentinel线程数限流不负责创建和管理线程池，而是简单统计当前请求上下文的线程个数，如果超出阈值，新的请求会被立即拒绝</p>
</li>
<li><p>代码：<code>Sentinel\sentinel-demo\sentinel-demo-basic\..\flow\FlowThreadDemo.java</code></p>
</li>
</ul>
<h4 id="QPS流量控制"><a href="#QPS流量控制" class="headerlink" title="QPS流量控制"></a>QPS流量控制</h4><ul>
<li>当QPS超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出 FlowException</li>
<li>代码：<code>Sentinel\sentinel-demo\sentinel-demo-basic\..\flow\FlowQpsDemo.java</code></li>
</ul>
<h3 id="5-熔断降级"><a href="#5-熔断降级" class="headerlink" title="5. 熔断降级"></a>5. 熔断降级</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408160644672.png" alt="image-20230408160644672"></p>
<h4 id="熔断策略—慢调用比例-SLOW-REQUEST-RATIO"><a href="#熔断策略—慢调用比例-SLOW-REQUEST-RATIO" class="headerlink" title="熔断策略—慢调用比例 (SLOW_REQUEST_RATIO)"></a>熔断策略—慢调用比例 (SLOW_REQUEST_RATIO)</h4><ul>
<li><p>代码：<code>Sentinel\sentinel-demo\sentinel-demo-basic\..\degrade\SlowRatioCircuitBreakerDemo.java</code></p>
</li>
<li><p>设置RT（最大的响应时间），用于判断慢调用</p>
</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408160732639.png" alt="image-20230408160732639"></p>
<h4 id="熔断策略—异常比例-ERROR-RATIO"><a href="#熔断策略—异常比例-ERROR-RATIO" class="headerlink" title="熔断策略—异常比例 (ERROR_RATIO)"></a>熔断策略—异常比例 (ERROR_RATIO)</h4><ul>
<li><p><code>代码：Sentinel\sentinel-demo\sentinel-demo-basic\..\degrade\ExceptionRatioCircuitBreakerDemo.java</code></p>
</li>
<li><p>异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p>
</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408160803154.png" alt="image-20230408160803154"></p>
<h4 id="熔断策略—异常数-ERROR-COUNT"><a href="#熔断策略—异常数-ERROR-COUNT" class="headerlink" title="熔断策略—异常数 (ERROR_COUNT)"></a>熔断策略—异常数 (ERROR_COUNT)</h4><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408160814319.png" alt="image-20230408160814319"></p>
<h3 id="6-Spring-Cloud-Alibaba-Sentinel"><a href="#6-Spring-Cloud-Alibaba-Sentinel" class="headerlink" title="6. Spring Cloud Alibaba Sentinel"></a>6. Spring Cloud Alibaba Sentinel</h3><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</a></li>
<li>例子代码：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba.git">https://github.com/alibaba/spring-cloud-alibaba.git</a><ul>
<li>子目录：spring-cloud-alibaba-examples</li>
</ul>
</li>
<li>增加依赖：spring-cloud-starter-alibaba-sentinel</li>
<li>配置控制台信息</li>
<li>HTTP 埋点（自动定义url资源）</li>
<li>Feign 支持，断路器支持</li>
<li>RestTemplate 支持</li>
<li>Spring Cloud Gateway 支持</li>
<li>Endpoint 支持（/actuator/sentinel）<ul>
<li>management.endpoints.web.exposure.include=*</li>
</ul>
</li>
</ul>
<h4 id="注册-DataSource"><a href="#注册-DataSource" class="headerlink" title="注册 DataSource"></a>注册 DataSource</h4><ul>
<li>目前支持file、nacos、zk、apollo、redis 这 5 种类型</li>
<li>FileRefreshableDataSource 和 NacosDataSource</li>
<li>nacos需要添加依赖sentinel-datasource-nacos</li>
</ul>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408160946106.png" alt="image-20230408160946106"></p>
<h4 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h4><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/image-20230408161036130.png" alt="image-20230408161036130"></p>
<h4 id="演示内容"><a href="#演示内容" class="headerlink" title="演示内容"></a>演示内容</h4><ul>
<li>访问sentinel控制台</li>
<li>访问get-licenses： <a target="_blank" rel="noopener" href="http://www.license.com/v1/organizations/e254f8c-c442-4ebe-a82a-e2fc1d1ff78a/licenses/">http://www.license.com/v1/organizations/e254f8c-c442-4ebe-a82a-e2fc1d1ff78a/licenses/</a></li>
<li>控制台查询：实时监控、簇点链路，可以看到已经自动创建了资源</li>
<li>定义流控规则（阈值0）、熔断规则</li>
<li>访问get-license-feign：<a target="_blank" rel="noopener" href="http://www.license.com/v1/organizations/e254f8c-c442-4ebe-a82a-e2fc1d1ff78a/licenses/f3831f8c-c338-4ebe-a82a-e2fc1d1ff78a/feign">http://www.license.com/v1/organizations/e254f8c-c442-4ebe-a82a-e2fc1d1ff78a/licenses/f3831f8c-c338-4ebe-a82a-e2fc1d1ff78a/feign</a></li>
<li>查看链路资源：<code>GET:http://organizationservice/v1/organizations/&#123;organizationId&#125;</code></li>
<li>定义熔断规则，测试发现返回了缺省值</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/NJU/">NJU</a>, <a href="/categories/NJU/服务端开发/">服务端开发</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Sentinel/">Sentinel</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 Whale
    
  </p>
</footer>
    
    
  </div>
</div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<!--<script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>-->
<!--<script src="//cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>