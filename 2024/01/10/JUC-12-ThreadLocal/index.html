<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="面试题  ThreadLocal中ThreadLocalMap的数据结构和关系 ThreadLocal的key是弱引用, 这是为什么？ ThreadLocal内存泄漏问题你知道吗？ ThreadLocal中最后为什么要加remove方法？   1. ThreadLocal简介ThreadLocal 提供线程局部变量。这些变量与正常的变量不同, 因为每一个线程在访问 ThreadLocal 实例的">
<meta property="og:type" content="article">
<meta property="og:title" content="JUC(12) ThreadLocal">
<meta property="og:url" content="https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/index.html">
<meta property="og:site_name" content="Whale&#39;s Blog">
<meta property="og:description" content="面试题  ThreadLocal中ThreadLocalMap的数据结构和关系 ThreadLocal的key是弱引用, 这是为什么？ ThreadLocal内存泄漏问题你知道吗？ ThreadLocal中最后为什么要加remove方法？   1. ThreadLocal简介ThreadLocal 提供线程局部变量。这些变量与正常的变量不同, 因为每一个线程在访问 ThreadLocal 实例的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111110081.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111543993.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111613314.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111620299.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111619171.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111620299.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401201853546.png">
<meta property="og:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401302225249.png">
<meta property="article:published_time" content="2024-01-10T09:56:50.000Z">
<meta property="article:modified_time" content="2024-01-30T15:36:14.190Z">
<meta property="article:author" content="Whale">
<meta property="article:tag" content="JUC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111110081.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>JUC(12) ThreadLocal</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/01/30/Java%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/01/09/JUC-11-CAS-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&text=JUC(12) ThreadLocal"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&is_video=false&description=JUC(12) ThreadLocal"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=JUC(12) ThreadLocal&body=Check out this article: https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&name=JUC(12) ThreadLocal&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&t=JUC(12) ThreadLocal"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ThreadLocal%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1. ThreadLocal简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ThreadLocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">2. ThreadLocal源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Thread%E3%80%81ThreadLocal%E3%80%81ThreadLocalMap%E5%85%B3%E7%B3%BB"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Thread、ThreadLocal、ThreadLocalMap关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">ThreadLocalMap 成员变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-get-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.2.</span> <span class="toc-text">ThreadLocal#get()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-getEntry-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.3.</span> <span class="toc-text">ThreadLocalMap#getEntry()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%93%88%E5%B8%8C%E7%A0%81-threadLocalHashCode-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">线程局部哈希码 threadLocalHashCode 源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-getEntryAfterMiss-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.5.</span> <span class="toc-text">ThreadLocalMap#getEntryAfterMiss()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-expungeStaleEntry-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.6.</span> <span class="toc-text">ThreadLocalMap#expungeStaleEntry()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-setInitialValue-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.7.</span> <span class="toc-text">ThreadLocal#setInitialValue()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-createMap-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.8.</span> <span class="toc-text">ThreadLocal#createMap()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-set-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.9.</span> <span class="toc-text">ThreadLocal#set()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-set-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.10.</span> <span class="toc-text">ThreadLocalMap#set()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-remove-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.11.</span> <span class="toc-text">ThreadLocal#remove()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-remove-%E6%BA%90%E7%A0%81-1"><span class="toc-number">2.2.12.</span> <span class="toc-text">ThreadLocal#remove()源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">3. ThreadLocal内存泄漏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%BC%BA%E3%80%81%E8%BD%AF%E3%80%81%E5%BC%B1%E3%80%81%E8%99%9A%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 强、软、弱、虚引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">强引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.2.</span> <span class="toc-text">软引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">弱引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.4.</span> <span class="toc-text">虚引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 为什么使用弱引用</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        JUC(12) ThreadLocal
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Whale</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-10T09:56:50.000Z" class="dt-published" itemprop="datePublished">2024-01-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Language/">Language</a> › <a class="category-link" href="/categories/Language/Java/">Java</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/JUC/" rel="tag">JUC</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <blockquote>
<p>面试题</p>
<ul>
<li>ThreadLocal中ThreadLocalMap的数据结构和关系</li>
<li>ThreadLocal的key是弱引用, 这是为什么？</li>
<li>ThreadLocal内存泄漏问题你知道吗？</li>
<li>ThreadLocal中最后为什么要加remove方法？</li>
</ul>
</blockquote>
<h2 id="1-ThreadLocal简介"><a href="#1-ThreadLocal简介" class="headerlink" title="1. ThreadLocal简介"></a>1. ThreadLocal简介</h2><p>ThreadLocal 提供线程局部变量。这些变量与正常的变量不同, 因为每一个线程在访问 ThreadLocal 实例的时候(通过其get或set方法)<strong>都有自己的、独立初始化的变量副本</strong>。ThreadLocal 实例通常是类中的私有静态字段, 使用它的目的是希望将状态(例如, 用户ID或事物ID)与线程关联起来。</p>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111110081.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span>&#123;<br>    ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>        threadLocal.set(threadLocal.get() + <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MyData</span> <span class="hljs-variable">myData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyData</span>();<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                threadPool.submit(() -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">Integer</span> <span class="hljs-variable">beforeInt</span> <span class="hljs-operator">=</span> myData.threadLocal.get();<br>                        myData.add();<br>                        <span class="hljs-type">Integer</span> <span class="hljs-variable">afterInt</span> <span class="hljs-operator">=</span> myData.threadLocal.get();<br>                        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; beforeInt: &quot;</span> + beforeInt + <span class="hljs-string">&quot; afterInt: &quot;</span> + afterInt);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        myData.threadLocal.remove();<br>                    &#125;<br>                &#125;);<br>            &#125;<br>            Thread.sleep(<span class="hljs-number">20</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            threadPool.shutdown();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">pool-1-thread-1 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-3 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-2 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-2 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-3 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-1 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-2 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-1 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-3 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">pool-1-thread-2 beforeInt: 0 afterInt: 1</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>
<p>如果不在 finally 块中调用 remove 会导致原先的值没有被清理, 默认值不再是 0, 而是上一个线程设置的值</p>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111543993.png" alt="image-20240111154336936"></p>
<p>因为每个 Thread 内有自己的<strong>实例副本</strong>且该副本只有当前线程自己使用</p>
<p>既然其他 ThreadLocal 不可访问, 那就不存在多线程间共享问题</p>
<p>统一设置初始值, 但是每个线程对这个值得修改都是各自线程互相独立的</p>
<p>如何才能不争抢</p>
<ul>
<li><p>加入synchronized或者Lock控制资源的访问顺序</p>
</li>
<li><p>ThreadLocal</p>
</li>
</ul>
<h2 id="2-ThreadLocal源码分析"><a href="#2-ThreadLocal源码分析" class="headerlink" title="2. ThreadLocal源码分析"></a>2. ThreadLocal源码分析</h2><h3 id="2-1-Thread、ThreadLocal、ThreadLocalMap关系"><a href="#2-1-Thread、ThreadLocal、ThreadLocalMap关系" class="headerlink" title="2.1 Thread、ThreadLocal、ThreadLocalMap关系"></a>2.1 Thread、ThreadLocal、ThreadLocalMap关系</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111613314.png" alt="image-20240111161342274" style="zoom: 80%;" /></p>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111620299.png" alt="image-20240111162037251" style="zoom:67%;" /></p>
<p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111619171.png" alt="img" style="zoom: 50%;" /></p>
<ul>
<li>Thread 对象维护着一个 ThreadLocalMap 的引用</li>
<li>ThreadLocalMap 是 ThreadLocal 的内部类, 用 Entry 来进行存储值</li>
<li>调用 ThreadLocal 的 set() 方法时, 实际上就是往 ThreadLocalMap 设置值, key 是 ThreadLocal 对象, 值 Value 是传递进来的对象</li>
<li>调用 ThreadLocal 的 get() 方法时, 实际上就是从 ThreadLocalMap 获取值, key 是 ThreadLocal 对象</li>
</ul>
<h3 id="2-2-源码分析"><a href="#2-2-源码分析" class="headerlink" title="2.2 源码分析"></a>2.2 源码分析</h3><h4 id="ThreadLocalMap-成员变量"><a href="#ThreadLocalMap-成员变量" class="headerlink" title="ThreadLocalMap 成员变量"></a>ThreadLocalMap 成员变量</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* The initial capacity -- MUST be a power of two.</span><br><span class="hljs-comment">* 初始容量——必须是2的幂。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INITIAL_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* The table, resized as necessary.</span><br><span class="hljs-comment">* table.length MUST always be a power of two.</span><br><span class="hljs-comment">* 表可根据需要调整大小。表长度必须始终是2的幂。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> Entry[] table;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* The number of entries in the table.</span><br><span class="hljs-comment">* 表中的实体数。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* The next size value at which to resize.</span><br><span class="hljs-comment">* 扩容阈值</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> threshold; <span class="hljs-comment">// Default to 0</span><br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocal-get-源码"><a href="#ThreadLocal-get-源码" class="headerlink" title="ThreadLocal#get()源码"></a><code>ThreadLocal#get()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Returns the value in the current thread&#x27;s copy of this</span><br><span class="hljs-comment"> * thread-local variable.  If the variable has no value for the</span><br><span class="hljs-comment"> * current thread, it is first initialized to the value returned</span><br><span class="hljs-comment"> * by an invocation of the &#123;<span class="hljs-doctag">@link</span> #initialValue&#125; method.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the current thread&#x27;s value of this thread-local</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t); <span class="hljs-comment">// 每个线程私有</span><br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 以当前ThreadLocal对象为key, 获取Entry, 其中存放了value</span><br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> setInitialValue();<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>此处说明 ThreadLocalMap 采用的是懒加载模式, 用时再去初始化</p>
</blockquote>
<h4 id="ThreadLocalMap-getEntry-源码"><a href="#ThreadLocalMap-getEntry-源码" class="headerlink" title="ThreadLocalMap#getEntry()源码"></a><code>ThreadLocalMap#getEntry()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Get the entry associated with key.  This method</span><br><span class="hljs-comment"> * itself handles only the fast path: a direct hit of existing</span><br><span class="hljs-comment"> * key. It otherwise relays to getEntryAfterMiss.  This is</span><br><span class="hljs-comment"> * designed to maximize performance for direct hits, in part</span><br><span class="hljs-comment"> * by making this method readily inlinable.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>  key the thread local object</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the entry associated with key, or null if no such</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Entry <span class="hljs-title function_">getEntry</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="hljs-number">1</span>);<br>    <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> table[i];<br>    <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span> &amp;&amp; e.get() == key)<br>        <span class="hljs-keyword">return</span> e;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> getEntryAfterMiss(key, i, e);<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>Entry 是 ThreadLocalMap 的内部类, 继承自<code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code>, 因此 <code>e.get()</code> 获取的就是该 Entry 对应的 ThreadLocal</p>
<p>算出当前 key 在数组中下标 i, 通过当前线程局部变量的线程局部哈希码与 数组长度 - 1 做与运算。根据下标 i 获取对象 e, 如果 e 不为 null 且 e 的 key 等于当前线程局部变量, 则返回 e, 否则开启线性探测</p>
</blockquote>
<h4 id="线程局部哈希码-threadLocalHashCode-源码"><a href="#线程局部哈希码-threadLocalHashCode-源码" class="headerlink" title="线程局部哈希码 threadLocalHashCode 源码"></a>线程局部哈希码 threadLocalHashCode 源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ThreadLocals rely on per-thread linear-probe hash maps attached</span><br><span class="hljs-comment"> * to each thread (Thread.threadLocals and</span><br><span class="hljs-comment"> * inheritableThreadLocals).  The ThreadLocal objects act as keys,</span><br><span class="hljs-comment"> * searched via threadLocalHashCode.  This is a custom hash code</span><br><span class="hljs-comment"> * (useful only within ThreadLocalMaps) that eliminates collisions</span><br><span class="hljs-comment"> * in the common case where consecutively constructed ThreadLocals</span><br><span class="hljs-comment"> * are used by the same threads, while remaining well-behaved in</span><br><span class="hljs-comment"> * less common cases.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadLocalHashCode</span> <span class="hljs-operator">=</span> nextHashCode();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The next hash code to be given out. Updated atomically. Starts at</span><br><span class="hljs-comment"> * zero.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">nextHashCode</span> <span class="hljs-operator">=</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The difference between successively generated hash codes - turns</span><br><span class="hljs-comment"> * implicit sequential thread-local IDs into near-optimally spread</span><br><span class="hljs-comment"> * multiplicative hash values for power-of-two-sized tables.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HASH_INCREMENT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x61c88647</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Returns the next hash code.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextHashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这里定义了一个 AtomicInteger 类型, 每次获取当前值并加上 HASH_INCREMENT, HASH_INCREMENT = 0x61c88647, 这个值和斐波那契散列有关(这是一种乘数散列法, 只不过这个乘数比较特殊, 是2^32乘以黄金分割比例的值, 即是1640531527, 16进制表示为 0x61c88647, 其主要目的就是为了让哈希码能均匀的分布在 2 的 n 次方的数组里, 也就是 Entry[] table 中, 这样做可以尽量避免 hash 冲突</p>
</blockquote>
<h4 id="ThreadLocalMap-getEntryAfterMiss-源码"><a href="#ThreadLocalMap-getEntryAfterMiss-源码" class="headerlink" title="ThreadLocalMap#getEntryAfterMiss()源码"></a><code>ThreadLocalMap#getEntryAfterMiss()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Version of getEntry method for use when key is not found in</span><br><span class="hljs-comment"> * its direct hash slot.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>  key the thread local object</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>  i the table index for key&#x27;s hash code</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span>  e the entry at table[i]</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the entry associated with key, or null if no such</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Entry <span class="hljs-title function_">getEntryAfterMiss</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, <span class="hljs-type">int</span> i, Entry e)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br><br>    <span class="hljs-keyword">while</span> (e != <span class="hljs-literal">null</span>) &#123;<br>        ThreadLocal&lt;?&gt; k = e.get();<br>        <span class="hljs-keyword">if</span> (k == key)<br>            <span class="hljs-keyword">return</span> e;<br>        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>)<br>            expungeStaleEntry(i);<br>        <span class="hljs-keyword">else</span><br>            i = nextIndex(i, len);<br>        e = tab[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextIndex</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> len)</span> &#123;<br>    <span class="hljs-keyword">return</span> ((i + <span class="hljs-number">1</span> &lt; len) ? i + <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>开启 while 循环, 当 e 的 key 与当前线程对象相等时, 返回 e</p>
<p>如果 e 的 key 等于 null, 开启探测式清理, 也就是 expungeStaleEntry() 方法</p>
<p>如果 e 的 key 不为 null, 且不等于当前线程对象, 说明哈希冲突了, 开启线性探测</p>
</blockquote>
<h4 id="ThreadLocalMap-expungeStaleEntry-源码"><a href="#ThreadLocalMap-expungeStaleEntry-源码" class="headerlink" title="ThreadLocalMap#expungeStaleEntry()源码"></a><code>ThreadLocalMap#expungeStaleEntry()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Expunge a stale entry by rehashing any possibly colliding entries</span><br><span class="hljs-comment"> * lying between staleSlot and the next null slot.  This also expunges</span><br><span class="hljs-comment"> * any other stale entries encountered before the trailing null.  See</span><br><span class="hljs-comment"> * Knuth, Section 6.4</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> staleSlot index of slot known to have null key</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the index of the next null slot after staleSlot</span><br><span class="hljs-comment"> * (all between staleSlot and this slot will have been checked</span><br><span class="hljs-comment"> * for expunging).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">expungeStaleEntry</span><span class="hljs-params">(<span class="hljs-type">int</span> staleSlot)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br><br>    <span class="hljs-comment">// expunge entry at staleSlot</span><br>    tab[staleSlot].value = <span class="hljs-literal">null</span>;<br>    tab[staleSlot] = <span class="hljs-literal">null</span>;<br>    size--;<br><br>    <span class="hljs-comment">// Rehash until we encounter null</span><br>    Entry e;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = nextIndex(staleSlot, len);<br>         (e = tab[i]) != <span class="hljs-literal">null</span>;<br>         i = nextIndex(i, len)) &#123;<br>        ThreadLocal&lt;?&gt; k = e.get();<br>        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) &#123;<br>            e.value = <span class="hljs-literal">null</span>;<br>            tab[i] = <span class="hljs-literal">null</span>;<br>            size--;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> k.threadLocalHashCode &amp; (len - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (h != i) &#123;<br>                tab[i] = <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-comment">// Unlike Knuth 6.4 Algorithm R, we must scan until</span><br>                <span class="hljs-comment">// null because multiple entries could have been stale.</span><br>                <span class="hljs-keyword">while</span> (tab[h] != <span class="hljs-literal">null</span>)<br>                    h = nextIndex(h, len);<br>                tab[h] = e;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>当前位置的 key 等于 null, value 也置为 null, entry 也置为 null, size—</p>
<p>从当前位置的下一个位置 i 开始循环, 如果 e 等于 null, 退出循环, 否则向 i 的下一个位置继续循环。</p>
<p>如果 e 的 key 等于 null, value 也置为 null, entry 也置为 null, size–-。不为 null, 则计算当前线程局部变量的下标 h。如果 h 与 i (当前下标)不相等, 说明当时插入的时候发生了哈希冲突。开始 rehash, 将当前下标的 entry 清空, 从 h 开始寻找空位, 找到空位后插入当前对象。如果恰好 h 下标为 null, 那么当前线程局部变量则不会发生哈希冲突, 直接插入到 h 位置。</p>
<p>HashMap与ThreadLocalMap解决哈希冲突的区别：</p>
<ul>
<li>HashMap 使用的是链地址法, 当发生哈希冲突的时候, 使用链表来存储相同哈希码的数据, 满足一定条件, 还可以链表红黑树互相转换</li>
<li>ThreadLocalMap 使用的是线性探测法, 当发生哈希冲突的时候, 就往后寻找空位置, 直到寻找到空位置插入。</li>
</ul>
</blockquote>
<h4 id="ThreadLocal-setInitialValue-源码"><a href="#ThreadLocal-setInitialValue-源码" class="headerlink" title="ThreadLocal#setInitialValue()源码"></a><code>ThreadLocal#setInitialValue()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Variant of set() to establish initialValue. Used instead</span><br><span class="hljs-comment"> * of set() in case user has overridden the set() method.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the initial value</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> T <span class="hljs-title function_">setInitialValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> initialValue(); <span class="hljs-comment">// 如果初始化ThreadLocal时没有重写就返回null</span><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        map.set(<span class="hljs-built_in">this</span>, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        createMap(t, value);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> <span class="hljs-keyword">instanceof</span> TerminatingThreadLocal) &#123;<br>        TerminatingThreadLocal.register((TerminatingThreadLocal&lt;?&gt;) <span class="hljs-built_in">this</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocal-createMap-源码"><a href="#ThreadLocal-createMap-源码" class="headerlink" title="ThreadLocal#createMap()源码"></a><code>ThreadLocal#createMap()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Create the map associated with a ThreadLocal. Overridden in</span><br><span class="hljs-comment"> * InheritableThreadLocal.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> t the current thread</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> firstValue value for the initial entry of the map</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> &#123;<br>    t.threadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocal-set-源码"><a href="#ThreadLocal-set-源码" class="headerlink" title="ThreadLocal#set()源码"></a><code>ThreadLocal#set()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Sets the current thread&#x27;s copy of this thread-local variable</span><br><span class="hljs-comment"> * to the specified value.  Most subclasses will have no need to</span><br><span class="hljs-comment"> * override this method, relying solely on the &#123;<span class="hljs-doctag">@link</span> #initialValue&#125;</span><br><span class="hljs-comment"> * method to set the values of thread-locals.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> value the value to be stored in the current thread&#x27;s copy of</span><br><span class="hljs-comment"> *        this thread-local.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        map.set(<span class="hljs-built_in">this</span>, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        createMap(t, value);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocalMap-set-源码"><a href="#ThreadLocalMap-set-源码" class="headerlink" title="ThreadLocalMap#set()源码"></a><code>ThreadLocalMap#set()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Set the value associated with key.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> key the thread local object</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> value the value to be set</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;<br><br>    <span class="hljs-comment">// We don&#x27;t use a fast path as with get() because it is at</span><br>    <span class="hljs-comment">// least as common to use set() to create new entries as</span><br>    <span class="hljs-comment">// it is to replace existing ones, in which case, a fast</span><br>    <span class="hljs-comment">// path would fail more often than not.</span><br><br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i];<br>         e != <span class="hljs-literal">null</span>;<br>         e = tab[i = nextIndex(i, len)]) &#123;<br>        ThreadLocal&lt;?&gt; k = e.get();<br><br>        <span class="hljs-keyword">if</span> (k == key) &#123;<br>            e.value = value; <span class="hljs-comment">// 覆盖</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) &#123;<br>            replaceStaleEntry(key, value, i); <br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    tab[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value); <span class="hljs-comment">// 插入</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> ++size;<br>    <span class="hljs-keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)<br>        rehash();<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocal-remove-源码"><a href="#ThreadLocal-remove-源码" class="headerlink" title="ThreadLocal#remove()源码"></a><code>ThreadLocal#remove()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Removes the current thread&#x27;s value for this thread-local</span><br><span class="hljs-comment"> * variable.  If this thread-local variable is subsequently</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@linkplain</span> #get read&#125; by the current thread, its value will be</span><br><span class="hljs-comment"> * reinitialized by invoking its &#123;<span class="hljs-doctag">@link</span> #initialValue&#125; method,</span><br><span class="hljs-comment"> * unless its value is &#123;<span class="hljs-doctag">@linkplain</span> #set set&#125; by the current thread</span><br><span class="hljs-comment"> * in the interim.  This may result in multiple invocations of the</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> initialValue&#125; method in the current thread.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.5</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> getMap(Thread.currentThread());<br>     <span class="hljs-keyword">if</span> (m != <span class="hljs-literal">null</span>) &#123;<br>         m.remove(<span class="hljs-built_in">this</span>);<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<h4 id="ThreadLocal-remove-源码-1"><a href="#ThreadLocal-remove-源码-1" class="headerlink" title="ThreadLocal#remove()源码"></a><code>ThreadLocal#remove()</code>源码</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Remove the entry for key.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i];<br>         e != <span class="hljs-literal">null</span>;<br>         e = tab[i = nextIndex(i, len)]) &#123;<br>        <span class="hljs-keyword">if</span> (e.get() == key) &#123;<br>            e.clear(); <span class="hljs-comment">// this.referent = null;</span><br>            expungeStaleEntry(i);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="3-ThreadLocal内存泄漏"><a href="#3-ThreadLocal内存泄漏" class="headerlink" title="3. ThreadLocal内存泄漏"></a>3. ThreadLocal内存泄漏</h2><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401111620299.png" alt="image-20240111162037251" style="zoom:67%;" /></p>
<ul>
<li>使用 <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code> 将 ThreadLocal 对象变成一个<strong>弱引用</strong>对象</li>
<li>定义 Entry 类来继承 <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code></li>
</ul>
<h3 id="3-1-强、软、弱、虚引用"><a href="#3-1-强、软、弱、虚引用" class="headerlink" title="3.1 强、软、弱、虚引用"></a>3.1 强、软、弱、虚引用</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401201853546.png" alt="image-20240120185333481" style="zoom:67%;" /></p>
<blockquote>
<p>Java 允许使用 <code>finalize()</code> 方法在垃圾收集器将对象从内存中清除出去之前做必要的清理工作</p>
</blockquote>
<h4 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h4><ul>
<li>对于强引用的对象, 就算是出现了 OOM 也不会对该对象进行回收</li>
<li>当一个对象被强引用变量引用时, 它处于可达状态, 是不可能被垃圾回收机制回收的, 即使该对象以后永远都不会被用到, JVM 也不会回收, 因此强引用是造成 Java 内存泄露的主要原因之一</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">MyObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>obj = <span class="hljs-literal">null</span>;<br>System.gc();<br></code></pre></td></tr></table></figure>
<h4 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h4><ul>
<li>是一种相对强引用弱化了一些的引用, 需要使用 <code>java.lang.ref.SoftReference</code> 类来实现, 可以让对象豁免一些垃圾回收</li>
<li>对于只有软引用的对象而言, <strong>当系统内存充足时, 不会被回收, 当系统内存不足时, 才会被回收</strong></li>
<li>软引用通常用在对内存敏感的程序中, 比如高速缓存, 内存够用就保留, 不够用就回收。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">SoftReference&lt;MyObject&gt; softRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br>softRef.get()<br></code></pre></td></tr></table></figure>
<blockquote>
<p>假如有一个应用需要读取大量的本地图片:</p>
<ul>
<li>如果每次读取图片都从硬盘读取则会严重影响性能</li>
<li>如果一次性全部加载到内存中又可能造成内存溢出。此时使用软引用可以解决这个问题。</li>
</ul>
<p>设计思路是: 用一个HashMap来保存图片的路径和相应图片对象关联的软引用之间的映射关系, 在内存不足时, JVM会自动回收这些缓存图片对象所占用的空间, 从而有效地避免了OOM的问题。</p>
<p><code>Map&lt;String, SoftReference&lt;Bitmap&gt;&gt; imageCache = new HashMap&lt;&gt;();</code></p>
</blockquote>
<h4 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h4><ul>
<li>使用 <code>java.lang.ref.WeakReference</code> 类来实现, 比软引用的生命周期更短, 对于只有弱引用的对象而言, 只要垃圾回收机制一运行, 不管JVM的内存空间是否足够, 都会回收该对象占用的内存。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">WeakSoftReference&lt;MyObject&gt; weakRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>());<br>weakRef.get()<br></code></pre></td></tr></table></figure>
<h4 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h4><ul>
<li><strong>虚引用必须和引用队列(<code>ReferenceQueue</code>)联合使用</strong><ul>
<li>虚引用需要 <code>java.lang.ref.PhantomReference</code> 类来实现, 与其他引用都不同, 虚引用并不决定对象的生命周期。<strong>如果一个对象仅持有虚引用, 那么它就和没有任何引用一样, 在任何时候都有可能被垃圾回收器回收, 它不能单独使用也不能通过它访问对象。</strong></li>
</ul>
</li>
<li><code>PhantomReference#get()</code> 总是返回 null<ul>
<li>虚引用的主要作用是跟踪对象被垃圾回收的状态。<strong>仅仅是提供了一种确保对象被 finalize 后, 做某些事情的通知机制。</strong></li>
</ul>
</li>
<li>处理监控通知使用<ul>
<li>设置虚引用关联对象的唯一目的, 就是在对象被 GC 的时候会收到一个系统通知或者后续添加进一步的处理, 用来实现比 finalize 机制更灵活的回收操作。</li>
</ul>
</li>
</ul>
<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">PhantomReference(T referent, ReferenceQueue&lt;? <span class="hljs-built_in">super</span> T&gt; q)<br></code></pre></td></tr></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">MyObject</span> <span class="hljs-variable">myObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyObject</span>();<br>ReferenceQueue&lt;MyObject&gt; referenceQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br>PhantomReference&lt;MyObject&gt; phantomReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span>&lt;&gt;(myObject, referenceQueue);<br><br>List&lt;<span class="hljs-type">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]);<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">500</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        System.out.println(phantomReference.get() + <span class="hljs-string">&quot; list add ok&quot;</span>);<br>    &#125;<br>&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        Reference&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MyObject</span>&gt; reference = referenceQueue.poll();<br>        <span class="hljs-keyword">if</span> (reference != <span class="hljs-literal">null</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;有虚对象回收加入了队列&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br></code></pre></td></tr></table></figure>
<h3 id="3-2-为什么使用弱引用"><a href="#3-2-为什么使用弱引用" class="headerlink" title="3.2 为什么使用弱引用"></a>3.2 为什么使用弱引用</h3><p><img src="https://whale-picture.oss-cn-hangzhou.aliyuncs.com/img/202401302225249.png" alt="image-20240130222547134"></p>
<p>为什么要用弱引用：</p>
<ul>
<li>当方法执行完毕后, 栈帧销毁, 强引用 tl 也就没有了, 但此时线程的 ThreadLocalMap 里某个 entry 的 key 引用还指向这个对象</li>
<li>若这个 key 是强引用, 就会导致 key 指向的 ThreadLocal 对象及 v 指向的对象不能被 gc 回收, 造成内存泄露</li>
<li>使用弱引用就可以使 ThreadLocal 对象在方法执行完毕后顺利被回收且 Entry 的 key 引用指向为 null</li>
</ul>
<p>但如果当前线程迟迟不结束(例如线程池场景), 这些 key 为 null 的 Entry 的 value 就会一直存在一条强引用链</p>
<ul>
<li>value 对象需要 ThreadLocalMap 调用 get, set 时发现 key 为 null 才会去回收整个 entry, 因此弱引用不能 100% 保证内存不泄露, 我们要在不使用某个 ThreadLocal 对象后, 手动调用 remove 方法来删除它</li>
<li><p>在线程池中, 不仅仅是内存泄漏的问题, 因为线程池中的线程是重复使用的, 意味着这个线程的 ThreadLocalMap 对象也是重复使用的, 如果我们不手动调用 remove 方法, 那么后面的线程就有可能获取到上个线程遗留下来的 value 值</p>
</li>
<li><p>此后调用 get, set, remove 方法时, 就会尝试删除 key 为 null 的 Entry, 从而释放 value 对象占用的内存</p>
<ul>
<li>通过 <code>expungeStaleEntry</code>, <code>cleanSomeSlots</code>, <code>replaceStaleEntry</code> 这三个方法回收键为 null 的 Entry 对象的值(即value)以及 entry 对象本身从而防止内存泄漏, 属于安全加固的方法</li>
</ul>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ThreadLocal%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1. ThreadLocal简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ThreadLocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">2. ThreadLocal源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Thread%E3%80%81ThreadLocal%E3%80%81ThreadLocalMap%E5%85%B3%E7%B3%BB"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Thread、ThreadLocal、ThreadLocalMap关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">ThreadLocalMap 成员变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-get-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.2.</span> <span class="toc-text">ThreadLocal#get()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-getEntry-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.3.</span> <span class="toc-text">ThreadLocalMap#getEntry()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%93%88%E5%B8%8C%E7%A0%81-threadLocalHashCode-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">线程局部哈希码 threadLocalHashCode 源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-getEntryAfterMiss-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.5.</span> <span class="toc-text">ThreadLocalMap#getEntryAfterMiss()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-expungeStaleEntry-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.6.</span> <span class="toc-text">ThreadLocalMap#expungeStaleEntry()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-setInitialValue-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.7.</span> <span class="toc-text">ThreadLocal#setInitialValue()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-createMap-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.8.</span> <span class="toc-text">ThreadLocal#createMap()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-set-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.9.</span> <span class="toc-text">ThreadLocal#set()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocalMap-set-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.10.</span> <span class="toc-text">ThreadLocalMap#set()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-remove-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.11.</span> <span class="toc-text">ThreadLocal#remove()源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ThreadLocal-remove-%E6%BA%90%E7%A0%81-1"><span class="toc-number">2.2.12.</span> <span class="toc-text">ThreadLocal#remove()源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">3. ThreadLocal内存泄漏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%BC%BA%E3%80%81%E8%BD%AF%E3%80%81%E5%BC%B1%E3%80%81%E8%99%9A%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 强、软、弱、虚引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.1.</span> <span class="toc-text">强引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.2.</span> <span class="toc-text">软引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">弱引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.4.</span> <span class="toc-text">虚引用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 为什么使用弱引用</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&text=JUC(12) ThreadLocal"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&is_video=false&description=JUC(12) ThreadLocal"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=JUC(12) ThreadLocal&body=Check out this article: https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&title=JUC(12) ThreadLocal"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&name=JUC(12) ThreadLocal&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://whale-lyi.github.io/2024/01/10/JUC-12-ThreadLocal/&t=JUC(12) ThreadLocal"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Whale
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
